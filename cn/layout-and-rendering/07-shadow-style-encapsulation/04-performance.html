<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>测试用例7：多实例与样式隔离</title>
  <link rel="stylesheet" href="base.css">
  <link id="globalStyles" rel="stylesheet" href="global.css">
  <style>
    /* Page-only helper styles (comments in English) */
    #grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:8px; margin-top:12px; }
    perf-element{ display:block; }
  </style>
  <script>
  // Define <perf-element> (comments in English)
  class PerfElement extends HTMLElement {
    constructor(){
      super();
      const shadow = this.attachShadow({ mode: 'open' });
      const styleEl = document.createElement('style');
      styleEl.textContent = `
        :host{ display:block; padding:8px; border:1px solid #ddd; border-radius:6px; background:#fff; }
        .inside{ color:#e53935; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      `;
      const wrapper = document.createElement('div');
      const p = document.createElement('p');
      p.className = 'inside';
      p.textContent = 'Perf 实例：Shadow 文本（红色）';
      wrapper.appendChild(p);
      shadow.append(styleEl, wrapper);
    }
  }
  customElements.define('perf-element', PerfElement);

  // Page logic to build many components and roughly measure costs
  async function rebuild(count){
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    const frag = document.createDocumentFragment();
    const t0 = performance.now();
    for(let i=0;i<count;i++){
      const el = document.createElement('perf-element');
      frag.appendChild(el);
    }
    const t1 = performance.now();
    grid.appendChild(frag);
    // Allow rendering to happen
    await new Promise(requestAnimationFrame);
    const t2 = performance.now();
    document.getElementById('statCreate').textContent = (t1 - t0).toFixed(2) + ' ms';
    document.getElementById('statInsert').textContent = (t2 - t1).toFixed(2) + ' ms';
    document.getElementById('statTotal').textContent = (t2 - t0).toFixed(2) + ' ms';
    document.getElementById('statCount').textContent = count;
  }

  async function triggerStyleRecalc(){
    // Very rough probe: toggle a class on body and measure 2 rAFs
    const t0 = performance.now();
    document.body.classList.toggle('probe');
    await new Promise(requestAnimationFrame);
    await new Promise(requestAnimationFrame);
    const t1 = performance.now();
    document.getElementById('statRecalc').textContent = (t1 - t0).toFixed(2) + ' ms';
  }

  window.addEventListener('DOMContentLoaded', () => {
    const link = document.getElementById('globalStyles');
    const chk = document.getElementById('toggleGlobal');
    const out = document.getElementById('toggleOutline');
    const btnBuild = document.getElementById('btnBuild');
    const btnClear = document.getElementById('btnClear');
    const btnRecalc = document.getElementById('btnRecalc');
    const num = document.getElementById('numCount');

    chk.addEventListener('change', () => { link.disabled = !chk.checked; });
    out.addEventListener('change', () => { document.body.classList.toggle('global-outline', out.checked); });

    btnBuild.addEventListener('click', () => {
      let n = parseInt(num.value, 10);
      if(!Number.isFinite(n) || n < 1) n = 1;
      if(n > 4000) n = 4000; // safety clamp
      rebuild(n);
    });
    btnClear.addEventListener('click', () => {
      document.getElementById('grid').innerHTML = '';
      document.getElementById('statCreate').textContent = '-';
      document.getElementById('statInsert').textContent = '-';
      document.getElementById('statTotal').textContent = '-';
      document.getElementById('statCount').textContent = '0';
      document.getElementById('statRecalc').textContent = '-';
    });
    btnRecalc.addEventListener('click', triggerStyleRecalc);

    // Build initial set
    rebuild(parseInt(num.value,10));
  });
  </script>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <h1 class="title">测试用例7：Shadow DOM 样式封装隔离 — 多实例与样式隔离</h1>
      <p class="subtitle">创建大量组件实例，观察样式计算与渲染是否互不干扰（仅做粗略观测）。</p>
    </div>
  </div>

  <div class="container">
    <div class="toolbar">
      <label class="group"><input id="toggleGlobal" type="checkbox" checked> 启用全局干扰样式（global.css）</label>
      <label class="group"><input id="toggleOutline" type="checkbox"> 显示页面全局轮廓（辅助观察）</label>
      <label class="group">实例数：<input id="numCount" type="number" min="1" max="4000" value="500" style="width:90px"></label>
      <button id="btnBuild">生成/重建</button>
      <button id="btnClear">清空</button>
      <button id="btnRecalc">触发样式重计算探测</button>
      <span class="badge">Chromium 最新版</span>
    </div>

    <div class="test-area">
      <h2>测试区域</h2>
      <div class="note">提示：该页面的时间统计仅用于相对对比与观察，不代表绝对性能指标。</div>
      <div id="grid"></div>
      <hr>
      <div class="grid">
        <div class="card"><strong>创建时间</strong><div id="statCreate">-</div></div>
        <div class="card"><strong>插入与首帧</strong><div id="statInsert">-</div></div>
        <div class="card"><strong>总耗时</strong><div id="statTotal">-</div></div>
        <div class="card"><strong>实例数量</strong><div id="statCount">0</div></div>
        <div class="card"><strong>粗略样式重计算</strong><div id="statRecalc">-</div></div>
      </div>
    </div>

    <div class="explain">
      <h3>测试目标</h3>
      <ul>
        <li>观察大量 Shadow DOM 组件共存时，样式计算是否仍各自独立。</li>
        <li>确认全局样式的增删不会影响组件内部样式。</li>
      </ul>
      <h3>期望结果</h3>
      <ul>
        <li>组件内部文本一律为红色；外部 Light DOM 文本（若有）受全局蓝色样式影响。</li>
        <li>切换全局样式开关不会改变组件内部的红色文本。</li>
      </ul>
    </div>
  </div>
</body>
</html>
