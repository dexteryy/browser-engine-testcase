<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>测试用例11-1：背景滤镜（backdrop-filter）滚动性能</title>
  <link rel="stylesheet" href="./shared.css">
  <script type="module">
    import { PerfHUD } from './perf-hud.js';
    // --- State ---
    const hud = new PerfHUD();
    const state = {
      enabled: true,
      blur: 5,
      alpha: 0.6,
      willChange: false,
      forceLayer: false,
      autoScroll: false,
      autoSpeed: 2, // px per frame
    };

    // --- Helpers ---
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const header = $('.masthead');

    function apply() {
      document.documentElement.style.setProperty('--backdrop-blur', state.blur + 'px');
      document.documentElement.style.setProperty('--backdrop-alpha', String(state.alpha));
      header.classList.toggle('masthead--glass', state.enabled);
      header.style.willChange = state.willChange ? 'backdrop-filter' : '';
      header.style.transform = state.forceLayer ? 'translateZ(0)' : '';
      $('#blurVal').textContent = state.blur + 'px';
      $('#alphaVal').textContent = Math.round(state.alpha*100) + '%';
      $('#flagEnabled').textContent = state.enabled ? '开' : '关';
      $('#flagWC').textContent = state.willChange ? 'on' : 'off';
      $('#flagLayer').textContent = state.forceLayer ? 'on' : 'off';
    }

    // --- Auto scroll loop ---
    let rafId = 0;
    function loop() {
      if (!state.autoScroll) return;
      window.scrollBy(0, state.autoSpeed);
      // bounce at edges
      if ((window.innerHeight + window.scrollY) >= document.body.scrollHeight || window.scrollY <= 0) {
        state.autoSpeed = -state.autoSpeed;
      }
      rafId = requestAnimationFrame(loop);
    }
    function toggleAutoScroll(on) {
      state.autoScroll = on;
      cancelAnimationFrame(rafId);
      if (on) rafId = requestAnimationFrame(loop);
    }

    // --- Bind UI ---
    window.addEventListener('DOMContentLoaded', () => {
      apply();
      $('#enable').addEventListener('change', e => { state.enabled = e.target.checked; apply(); });
      $('#blur').addEventListener('input', e => { state.blur = +e.target.value; apply(); });
      $('#alpha').addEventListener('input', e => { state.alpha = +e.target.value; apply(); });
      $('#wc').addEventListener('change', e => { state.willChange = e.target.checked; apply(); });
      $('#layer').addEventListener('change', e => { state.forceLayer = e.target.checked; apply(); });

      $('#auto').addEventListener('change', e => toggleAutoScroll(e.target.checked));
      $('#speed').addEventListener('input', e => state.autoSpeed = +e.target.value);

      $('#hud').addEventListener('change', e => e.target.checked ? hud.start() : hud.stop());
      $('#reset').addEventListener('click', () => {
        Object.assign(state, {enabled:true, blur:5, alpha:0.6, willChange:false, forceLayer:false, autoScroll:false, autoSpeed:2});
        apply();
        toggleAutoScroll(false);
        $('#enable').checked = true;
        $('#blur').value = 5;
        $('#alpha').value = 0.6;
        $('#wc').checked = false;
        $('#layer').checked = false;
        $('#auto').checked = false;
        $('#speed').value = 2;
        $('#hud').checked = false;
        hud.stop();
        window.scrollTo({top:0});
      });
    });
  </script>
</head>
<body>
  <!-- 顶栏：标题 + 一句话说明（本页同时作为被测固定半透明栏） -->
  <header class="masthead masthead--glass">
    <div class="container title">
      <h1>测试用例11-1：背景滤镜（backdrop-filter）滚动性能</h1>
      <span class="sub">固定半透明栏应用 <code>backdrop-filter: blur()</code>，滚动观察背景模糊和重绘</span>
    </div>
  </header>

  <main class="container">
    <!-- 工具栏 -->
    <section class="toolbar" aria-label="工具栏">
      <div class="row">
        <div class="group"><label><input id="enable" type="checkbox" checked> 启用 backdrop-filter</label></div>
        <div class="group"><label>模糊半径 <input id="blur" type="range" min="0" max="20" step="1" value="5"></label><span class="num" id="blurVal">5px</span></div>
        <div class="group"><label>透明度 <input id="alpha" type="range" min="0.2" max="0.95" step="0.01" value="0.6"></label><span class="num" id="alphaVal">60%</span></div>
        <div class="group"><label><input id="wc" type="checkbox"> will-change: backdrop-filter</label></div>
        <div class="group"><label><input id="layer" type="checkbox"> 强制合成层(transform: translateZ(0))</label></div>
      </div>
      <div class="row">
        <div class="group"><label><input id="auto" type="checkbox"> 自动滚动</label></div>
        <div class="group"><label>速度 <input id="speed" type="range" min="1" max="12" step="1" value="2"></label><span class="num">px/帧</span></div>
        <div class="group"><label><input id="hud" type="checkbox"> 开启性能HUD</label></div>
        <button id="reset">重置</button>
      </div>
    </section>

    <!-- 测试区域 -->
    <section class="test-area">
      <div class="section">
        <h2>测试区域：长内容滚动</h2>
        <p class="meta">滚动页面，观察顶栏后的内容是否实时模糊且平滑；关注流畅度和是否出现“未模糊的一帧”。</p>
      </div>
      <div class="scroller long-list" id="longList">
        <!-- Repeat blocks of text to ensure tall scroll height -->
        <p>为了方便观察，本页提供高对比度的背景图像和大量文本。请上下滚动，注意顶栏后的文字与图片是否立即被模糊，过渡是否平滑。</p>
        <p>建议结合 DevTools 的 <b>Paint Flashing</b> 与 <b>Layer Borders</b>：若顶栏区域持续闪烁绿色，说明滚动时存在每帧重绘。</p>
        <img src="./assets/pattern.svg" alt="彩色网格背景" style="width:100%;border-radius:12px;border:1px solid #e5e7eb;box-shadow:0 8px 30px rgba(0,0,0,.1);margin:16px 0;">
        <p>段落 1：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 2：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 3：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 4：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 5：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 6：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 7：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 8：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 9：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 10：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 11：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 12：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 13：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 14：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 15：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 16：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 17：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 18：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 19：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 20：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 21：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 22：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 23：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 24：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 25：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 26：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 27：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 28：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 29：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 30：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 31：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 32：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 33：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 34：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 35：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 36：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 37：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 38：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 39：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 40：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 41：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 42：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 43：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 44：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 45：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 46：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 47：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 48：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 49：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 50：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 51：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 52：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 53：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 54：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
<p>段落 55：这是用于滚动的占位文本。模糊半径较大时，边缘会呈现明显的光晕。请留意滚动中的细节变化。</p>
      </div>
    </section>

    <!-- 解释说明 -->
    <section class="explain" aria-label="解释说明">
      <div class="section">
        <h3>测试目标</h3>
        <ul>
          <li>验证背景滤镜视觉是否正确（顶栏后的内容应被实时模糊，类似“毛玻璃”）。</li>
          <li>在滚动时评估是否出现频繁重绘与帧率下降。</li>
        </ul>
      </div>
      <div class="section">
        <h3>使用方法</h3>
        <ul>
          <li>静止检查：确认顶栏区域呈明显模糊，边缘不过度锐利或出现异常遮罩。</li>
          <li>滚动检查：上下滚动，观察模糊是否随背景实时更新且没有“未模糊的一瞬间”。</li>
          <li>可调参数：在工具栏调节模糊半径与透明度，可选择 <code>will-change</code> 与“强制合成层”。</li>
          <li>量化建议：打开 DevTools → More Tools → Rendering → 勾选 <b>Paint Flashing</b> 与 <b>Layer Borders</b> 观察重绘与合成层。</li>
        </ul>
      </div>
      <div class="section">
        <h3>结果评估</h3>
        <ul>
          <li>理想情况：顶栏与背景各自成为独立合成层，滚动主要由 GPU 合成完成，帧率接近 60 FPS。</li>
          <li>若帧率下降或闪烁：尝试勾选 <code>will-change</code> 或“强制合成层”，观察是否改善；减少模糊半径。</li>
        </ul>
      </div>
    </section>

    <nav class="footer-nav">
      <a href="./02-foreground-filter.html">前往 11-2：前景滤镜（filter）</a>
      <a href="./03-combined.html">前往 11-3：综合场景</a>
    </nav>
  </main>
  <script type="module">
    // No-op: module block exists to keep type=module for import maps consistency in some tools
  </script>
</body>
</html>
