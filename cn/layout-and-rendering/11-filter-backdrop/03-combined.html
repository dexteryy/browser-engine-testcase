<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>测试用例11-3：综合场景（背景滤镜 + 前景滤镜）</title>
  <link rel="stylesheet" href="./shared.css">
  <script src="./perf-hud.js" defer></script>
  <script defer>
    (function(){
      function $(s,ctx){ return (ctx||document).querySelector(s); }
      var hud = null;
      var state = {
        bdEnabled:true, bdBlur:5, bdAlpha:.6, bdWC:false, bdLayer:false,
        imEnabled:true, imBlur:5, imWC:false, imLayer:false,
        auto:false, speed:2
      };
      var rafId = 0;

      function apply(){
        document.documentElement.style.setProperty('--backdrop-blur', state.bdBlur + 'px');
        document.documentElement.style.setProperty('--backdrop-alpha', String(state.bdAlpha));
        document.documentElement.style.setProperty('--img-blur', state.imBlur + 'px');

        var hd = $('.masthead');
        if (hd){
          hd.classList.toggle('masthead--glass', state.bdEnabled);
          hd.style.willChange = state.bdWC ? 'backdrop-filter' : '';
          hd.style.transform = state.bdLayer ? 'translateZ(0)' : '';
        }
        var img = $('.photo');
        if (img){
          img.dataset.enabled = state.imEnabled ? 'true' : 'false';
          img.style.willChange = state.imWC ? 'filter' : '';
          img.style.transform = state.imLayer ? 'translateZ(0)' : '';
        }
        $('#bdBlurVal').textContent = state.bdBlur + 'px';
        $('#bdAlphaVal').textContent = Math.round(state.bdAlpha * 100) + '%';
        $('#imBlurVal').textContent = state.imBlur + 'px';
      }

      function loop(){
        if(!state.auto) return;
        window.scrollBy(0, state.speed);
        if ((window.innerHeight + window.scrollY) >= document.body.scrollHeight || window.scrollY <= 0) {
          state.speed = -state.speed;
        }
        rafId = requestAnimationFrame(loop);
      }
      function toggleAuto(on){
        cancelAnimationFrame(rafId);
        state.auto = on;
        if(on) rafId = requestAnimationFrame(loop);
      }

      document.addEventListener('DOMContentLoaded', function(){
        hud = new window.PerfHUD();

        // Bind controls
        $('#bdEnable').addEventListener('change', function(e){ state.bdEnabled = e.target.checked; apply(); });
        $('#bdBlur').addEventListener('input', function(e){ state.bdBlur = +e.target.value; apply(); });
        $('#bdAlpha').addEventListener('input', function(e){ state.bdAlpha = +e.target.value; apply(); });
        $('#bdWC').addEventListener('change', function(e){ state.bdWC = e.target.checked; apply(); });
        $('#bdLayer').addEventListener('change', function(e){ state.bdLayer = e.target.checked; apply(); });

        $('#imEnable').addEventListener('change', function(e){ state.imEnabled = e.target.checked; apply(); });
        $('#imBlur').addEventListener('input', function(e){ state.imBlur = +e.target.value; apply(); });
        $('#imWC').addEventListener('change', function(e){ state.imWC = e.target.checked; apply(); });
        $('#imLayer').addEventListener('change', function(e){ state.imLayer = e.target.checked; apply(); });

        $('#auto').addEventListener('change', function(e){ toggleAuto(e.target.checked); });
        $('#speed').addEventListener('input', function(e){ state.speed = +e.target.value; });
        $('#hud').addEventListener('change', function(e){ e.target.checked ? hud.start() : hud.stop(); });
        $('#reset').addEventListener('click', function(){
          Object.assign(state, {bdEnabled:true, bdBlur:5, bdAlpha:.6, bdWC:false, bdLayer:false, imEnabled:true, imBlur:5, imWC:false, imLayer:false, auto:false, speed:2});
          $('#bdEnable').checked=true; $('#bdBlur').value=5; $('#bdAlpha').value=.6; $('#bdWC').checked=false; $('#bdLayer').checked=false;
          $('#imEnable').checked=true; $('#imBlur').value=5; $('#imWC').checked=false; $('#imLayer').checked=false;
          $('#auto').checked=false; $('#speed').value=2; $('#hud').checked=false; hud.stop();
          apply(); window.scrollTo({top:0});
        });

        apply();
      });
    })();
  </script>
</head>
<body>
  <!-- 顶栏（玻璃态，同时作为被测背景滤镜元素） -->
  <header class="masthead masthead--glass">
    <div class="container title">
      <h1>测试用例11-3：综合场景</h1>
      <span class="sub">固定半透明栏（背景模糊） + 正文图片（前景模糊）</span>
    </div>
  </header>

  <main class="container">
    <section class="toolbar" aria-label="工具栏">
      <div class="row">
        <span class="badge">背景滤镜</span>
        <div class="group"><label><input id="bdEnable" type="checkbox" checked> 启用 backdrop-filter</label></div>
        <div class="group"><label>模糊 <input id="bdBlur" type="range" min="0" max="20" value="5"></label><span class="num" id="bdBlurVal">5px</span></div>
        <div class="group"><label>透明度 <input id="bdAlpha" type="range" min="0.2" max="0.95" step="0.01" value="0.6"></label><span class="num" id="bdAlphaVal">60%</span></div>
        <div class="group"><label><input id="bdWC" type="checkbox"> will-change</label></div>
        <div class="group"><label><input id="bdLayer" type="checkbox"> 合成层</label></div>
      </div>
      <div class="row">
        <span class="badge">前景滤镜</span>
        <div class="group"><label><input id="imEnable" type="checkbox" checked> 启用 filter</label></div>
        <div class="group"><label>模糊 <input id="imBlur" type="range" min="0" max="20" value="5"></label><span class="num" id="imBlurVal">5px</span></div>
        <div class="group"><label><input id="imWC" type="checkbox"> will-change</label></div>
        <div class="group"><label><input id="imLayer" type="checkbox"> 合成层</label></div>
      </div>
      <div class="row">
        <div class="group"><label><input id="auto" type="checkbox"> 自动滚动</label></div>
        <div class="group"><label>速度 <input id="speed" type="range" min="1" max="12" step="1" value="2"></label><span class="num">px/帧</span></div>
        <div class="group"><label><input id="hud" type="checkbox"> 开启性能HUD</label></div>
        <button id="reset">重置</button>
      </div>
    </section>

    <section class="test-area">
      <div class="section">
        <h2>测试区域：滚动 + 两类滤镜叠加</h2>
        <p class="meta">让不同内容经过顶栏后方，同时观察正文图片的模糊效果与整体流畅度。</p>
      </div>
      <div class="scroller long-list">
        <p>段落 1：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 2：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 3：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 4：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 5：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 6：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 7：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 8：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 9：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 10：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 11：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 12：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 13：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 14：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 15：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
<p>段落 16：用于滚动的占位文本。背景与前景滤镜叠加时，注意有无穿透或遮罩错误。</p>
        <div class="photo-wrap">
          <img class="photo" src="./assets/pattern.svg" alt="彩色网格背景（用于观察模糊效果）" data-enabled="true" onerror="this.replaceWith(document.createTextNode('图片加载失败：请确认 assets/pattern.svg 是否存在'))">
        </div>
        <p>段落 17：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 18：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 19：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 20：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 21：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 22：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 23：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 24：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 25：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 26：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 27：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 28：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 29：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 30：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 31：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 32：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 33：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 34：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 35：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 36：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 37：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 38：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 39：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 40：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 41：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 42：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 43：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 44：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 45：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 46：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 47：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 48：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 49：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 50：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 51：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 52：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 53：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
<p>段落 54：继续滚动，留意顶栏后的模糊是否与图片的前景模糊相互影响（理论上互不影响）。</p>
      </div>
    </section>

    <section class="explain" aria-label="解释说明">
      <div class="section">
        <h3>测试目标</h3>
        <ul>
          <li>验证前景滤镜与背景滤镜在同一页面上的叠加时的渲染正确性。</li>
          <li>对比启用/禁用各类优化提示时的滚动与合成性能。</li>
        </ul>
      </div>
      <div class="section">
        <h3>使用方法</h3>
        <ul>
          <li>滚动页面观察顶栏后的内容模糊是否稳定，图片模糊是否始终生效。</li>
          <li>逐项切换 will-change 与“合成层”，尝试量化 HUD 的 FPS 与 P95 帧时。</li>
          <li>遇到明显掉帧时，逐步降低模糊半径，观察阈值。</li>
        </ul>
      </div>
      <div class="section">
        <h3>结果评估</h3>
        <ul>
          <li>理想表现：两类滤镜各自独立合成；滚动主要由 GPU 合成完成；无穿透/遮罩伪像。</li>
          <li>可疑表现：出现未模糊的一帧、顶栏边缘发白、或 HUD 显示大量 Jank/LongTasks。</li>
        </ul>
      </div>
    </section>

    <nav class="footer-nav">
      <a href="./01-backdrop-scroll.html">返回 11-1：背景滤镜</a>
      <a href="./02-foreground-filter.html">返回 11-2：前景滤镜</a>
    </nav>
  </main>
</body>
</html>
